DECLARE @JOURNALNUM VARCHAR(10), @SYSTEMID VARCHAR(4)
SET @JOURNALNUM = '13250'
SET @SYSTEMID = 'NOAX'

--header
SELECT 
@SYSTEMID+JOURNALNUM AS UNIQUE_ID,
@SYSTEMID AS ACCOUNTING_LOGSYS,
'' AS OBJECT_LOGSYS,
JOURNALNUM AS OBJECT_KEY,
@SYSTEMID+JOURNALNUM AS REFERENCE_DOCUMENT_NO,
'' AS BUSINESS_ACTIVITY,
'' AS DOCUMENT_TYPE,
'' AS PREDECESSOR_REFERENCE_KEY,
NAME AS HEADER_TXT,
CAST(POSTEDDATETIME AS DATE) AS DOCUMENT_DATE,
CAST(POSTEDDATETIME AS DATE) AS POSTING_DATE,
'' AS PRDTAX_REPORTING_DATE,
'' AS INVOICE_RECEIPT_DATE,
CAST(POSTEDDATETIME AS DATE) AS TRANSLATION_DATE,
EXCHRATE AS EXCHANGE_RATE,
UPPER(DATAAREAID) AS COMP_CODE,
'' AS FISCAL_YEAR,
'' AS FISCAL_PERIOD,
'' AS ACCOUNTING_DOC_NO,
CREATEDBY AS USERNAME,
CAST(POSTEDDATETIME AS DATE) AS CREATE_TIMESTAMP,
'' AS OBJECT_KEY_REVERSAL,
'' AS REASON_REVERSAL
FROM LEDGERJOURNALTABLE
WHERE JOURNALNUM = @JOURNALNUM

--lines
SELECT @SYSTEMID+LEDGERJOURNALTRANSLEDGERDIMENSIONVIEW.JOURNALNUM AS UNIQUE_ID,									
LEDGERJOURNALTRANSLEDGERDIMENSIONVIEW.LINENUM AS ITEMNO_ACC,
LEDGERJOURNALTRANSLEDGERDIMENSIONVIEW.LINENUM AS DOC_LINE_NO,
UPPER(LEDGERJOURNALTRANSLEDGERDIMENSIONVIEW.DATAAREAID) AS COMP_CODE,
case 
	when LEDGERJOURNALTRANSLEDGERDIMENSIONVIEW.ACCOUNT LIKE '%-%' THEN LEFT(LEDGERJOURNALTRANSLEDGERDIMENSIONVIEW.ACCOUNT, CHARINDEX('-',LEDGERJOURNALTRANSLEDGERDIMENSIONVIEW.ACCOUNT)-1) 
	else LEDGERJOURNALTRANSLEDGERDIMENSIONVIEW.ACCOUNT 
END AS GL_ACCOUNT, -- NEEDS CONFIRMING

LEDGERJOURNALTRANSLEDGERDIMENSIONVIEW.CURRENCYCODE AS DOCUMENT_CURR_ISO,
LEDGERJOURNALTRANSLEDGERDIMENSIONVIEW.AMOUNTCURCREDIT,
LEDGERJOURNALTRANSLEDGERDIMENSIONVIEW.AMOUNTCURDEBIT,
'' AS COMP_CODE_CURR_ISO,
'' AS AMT_COMP_CODE_CURR,
LEDGERJOURNALTRANSLEDGERDIMENSIONVIEW.TXT AS ITEM_TEXT,
'' AS ALLOC_NO,
'' AS PRDTAX_CODE,
'' AS PRDTAX_JURISDICTION_CODE,
'' AS PRDTAX_ITEMNO,
'' AS PLANT,
'' AS MATERIAL_NO,
'' AS QUANTITY,
'' AS BASE_UOM_ISO,
'' AS CASH_DISCOUNT_INDICATOR,
'' AS PROFIT_CENTER,
'' AS PARTNER_PROFIT_CENTER,
'' AS SEGMENT,
'' AS PARTNER_SEGMENT,
DIMATT.CostCenter AS COST_CENTER, -- NEEDS CONFIRMING
'' AS COST_CENTER_ACTIVITY_TYPE,
'' AS WBS_ELEMENT,
'' AS SALES_ORDER,
'' AS SALES_ORDER_ITEM_NO,
'' AS INTERNAL_ORDER,
'' AS CUSTOMER,
'' AS CUSTOMER_GROUP,
'' AS CUSTOMER_INDUSTRY,
'' AS CUSTOMER_COUNTRY,
'' AS SALES_DISTRICT,
'' AS SOLD_MATERIAL,
'' AS SOLD_MATERIAL_GROUP,
'' AS SALES_ORGANIZATION,
'' AS DISTRIBUTION_CHANNEL,
'' AS DIVISION,
'' AS ACCOUNT_ASSIGMENT_TYPE,
'' AS TRADING_PARTNER_ID,
'' AS LOGICAL_TRANSACTION
 FROM LEDGERJOURNALTRANSLEDGERDIMENSIONVIEW 
 LEFT JOIN (SELECT DIMENSIONATTRIBUTEVALUEGROUP, 
			MAX(CASE ORDINAL WHEN 1 THEN DISPLAYVALUE ELSE '' END) AS 'MainAccount',
			MAX(CASE ORDINAL WHEN 2 THEN DISPLAYVALUE ELSE '' END) AS 'BusinessUnit',
			MAX(CASE ORDINAL WHEN 3 THEN DISPLAYVALUE ELSE '' END) AS 'Department',
			MAX(CASE ORDINAL WHEN 4 THEN DISPLAYVALUE ELSE '' END) AS 'CostCenter',
			MAX(CASE ORDINAL WHEN 5 THEN DISPLAYVALUE ELSE '' END) AS 'ItemGroup'
		FROM
			(SELECT DALV.DIMENSIONATTRIBUTEVALUEGROUP, DALV.DISPLAYVALUE, DALV.ORDINAL, ROW_NUMBER()
				OVER (PARTITION BY DALV.DIMENSIONATTRIBUTEVALUEGROUP ORDER BY DALV.ORDINAL ASC) AS 'For Sorting'
				FROM DIMENSIONATTRIBUTEVALUECOMBINATION DAVC
				LEFT JOIN DIMENSIONATTRIBUTEVALUEGROUPCOMBINATION DAVGC
				ON DAVC.RECID = DAVGC.DIMENSIONATTRIBUTEVALUECOMBINATION
				LEFT JOIN DIMENSIONATTRIBUTEVALUEGROUP DAVG
				ON DAVGC.DIMENSIONATTRIBUTEVALUECOMBINATION = DAVG.RECID
				LEFT JOIN DIMENSIONATTRIBUTELEVELVALUE DALV
			ON DAVG.RECID = DALV.DIMENSIONATTRIBUTEVALUEGROUP
			) AS SourceTable
			GROUP BY DIMENSIONATTRIBUTEVALUEGROUP) DIMATT
	ON LEDGERJOURNALTRANSLEDGERDIMENSIONVIEW.LEDGERDIMENSION = DIMATT.DIMENSIONATTRIBUTEVALUEGROUP
WHERE JOURNALNUM = @JOURNALNUM
ORDER BY LEDGERJOURNALTRANSLEDGERDIMENSIONVIEW.LINENUM
